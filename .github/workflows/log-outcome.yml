name: Log Blizzard Outcome

on:
  workflow_dispatch:
    inputs:
      event_date:
        description: 'Prediction date (YYYY-MM-DD)'
        required: true
        type: string
      actual_outcome:
        description: 'Select the actual result'
        required: true
        type: choice
        options:
          - snow-day
          - school-open
          - no-school
      no_school_reason:
        description: 'If no-school, why? (weekend, thanksgiving, winter-break, etc.)'
        required: false
        type: choice
        options:
          - ''
          - weekend
          - thanksgiving
          - winter-break
          - spring-break
          - teacher-day
          - mlk-day
          - presidents-day
          - memorial-day
          - other
      notes:
        description: 'Optional notes or context'
        required: false
        type: string
      blizzard_prediction:
        description: 'Blizzard AI prediction (0-100) - manual override when workflow misses it'
        required: false
        type: string
      rhs_prediction:
        description: 'Rockford High School prediction (0-100) - competition tracking'
        required: false
        type: string

jobs:
  append-record:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update outcomes ledger
        env:
          EVENT_DATE: ${{ inputs.event_date }}
          OUTCOME: ${{ inputs.actual_outcome }}
          NO_SCHOOL_REASON: ${{ inputs.no_school_reason }}
          NOTES: ${{ inputs.notes }}
          BLIZZARD_PREDICTION: ${{ inputs.blizzard_prediction }}
          RHS_PREDICTION: ${{ inputs.rhs_prediction }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: node build-tools/update-outcomes-ledger.mjs

      - name: Commit outcome entry
        env:
          EVENT_DATE: ${{ inputs.event_date }}
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add public/data/outcomes.json
          git commit -m "Log outcome for ${EVENT_DATE:-${{ inputs.event_date }}}"
          git push

      - name: Trigger site deployment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            })
